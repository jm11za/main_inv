# AI 기반 3개월 스윙 트레이딩 시스템 - 아키텍처 설계서 v2.0

> **변경 이력**
> - v1.0 (2025-01-31): 초안 작성
> - v2.0 (2025-01-31): Layer 3.5 (Dynamic Stock Filtering) 추가, 전체 흐름 설명 보강
> - v2.1 (2026-01-31): Sentiment Reader A+B+C 통합 분석, 토론방 크롤러 추가, 섹터 라벨링 로직 개선
> - v3.0 (2026-02-01): **SectorCategory Enum 제거 → 네이버 테마명 문자열 직접 사용**, N:M 종목-테마 관계 지원, 모듈 구조 개편

---

## 📋 목차

1. [시스템 개요 및 핵심 철학](#1-시스템-개요-및-핵심-철학)
2. [전체 아키텍처 (7-Layer 구조)](#2-전체-아키텍처-7-layer-구조)
3. [레이어별 상세 설계](#3-레이어별-상세-설계)
4. [데이터 흐름도](#4-데이터-흐름도)
5. [공통 인프라 모듈](#5-공통-인프라-모듈)
6. [디렉토리 구조](#6-디렉토리-구조)
7. [핵심 인터페이스 정의](#7-핵심-인터페이스-정의)
8. [데이터 모델](#8-데이터-모델)
9. [실행 파이프라인](#9-실행-파이프라인)
10. [확장 포인트 및 에러 처리](#10-확장-포인트-및-에러-처리)

---

## 1. 시스템 개요 및 핵심 철학

### 1.1 시스템 목표

**3개월(분기) 단위 스윙 트레이딩에 최적화된 종목 발굴 시스템**

### 1.2 핵심 철학

> "가격은 속여도, 돈(수급)과 쪽수(결속력)는 속이지 못한다."

이 시스템은 다음 두 가지 접근을 결합합니다:

| 접근 방식 | 설명 | 담당 레이어 |
|-----------|------|-------------|
| **Bottom-up** | 개별 종목의 재무/수급 데이터 분석 | Layer 1~4 |
| **Top-down** | 시장 주도 섹터 식별 및 흐름 파악 | Layer 2~3 |
| **LLM 검증** | 정성적 재료/심리 분석 | Layer 3.5, 5 |

### 1.3 왜 이 구조인가? (핵심 설계 원칙)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  전통적 스크리닝의 문제점                                                │
│  ─────────────────────────────────────────────────────────────────────  │
│  "모든 종목에 동일한 잣대를 적용한다"                                     │
│                                                                         │
│  예시:                                                                   │
│  - 삼성바이오로직스: 영업이익 흑자 → 통과 ✓                              │
│  - 신생 바이오벤처: 영업이익 적자 → 탈락 ✗ (하지만 이게 진짜 대장주!)    │
│                                                                         │
│  결과: 성장주의 대장주를 놓치고, 실적주의 잡주만 남는 역설               │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  본 시스템의 해결책: "이원화 필터링" (Layer 3.5)                         │
│  ─────────────────────────────────────────────────────────────────────  │
│  "섹터의 DNA를 먼저 파악하고, 그에 맞는 잣대를 적용한다"                 │
│                                                                         │
│  Step 1: LLM이 섹터 성격 규명 (Type A 실적형 / Type B 성장형)           │
│  Step 2: Type별로 다른 필터 적용                                        │
│  Step 3: 통과한 종목만 스코어링                                         │
│                                                                         │
│  결과: 바이오 대장주도 살리고, 부실 잡주도 걸러낸다                      │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 전체 아키텍처 (7-Layer 구조)

### 2.1 High-Level View

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ORCHESTRATOR (Main Controller)                      │
│                         일 1회 배치 실행 / 전체 파이프라인 관리                      │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
        ┌───────────────────────────────┼───────────────────────────────┐
        ▼                               ▼                               ▼
┌───────────────┐              ┌───────────────┐              ┌───────────────┐
│   LAYER 1     │              │   LAYER 2     │              │   LAYER 3     │
│  Data Ingest  │─────────────▶│  Processing   │─────────────▶│   Analysis    │
│   (수집층)     │              │   (처리층)     │              │   (분석층)     │
└───────────────┘              └───────────────┘              └───────────────┘
                                                                       │
                                                                       ▼
                                                              ┌───────────────┐
                                                              │  LAYER 3.5    │
                                                              │   Filtering   │
                                                              │  (필터링층)    │◀── ★ 핵심 신규 추가
                                                              └───────────────┘
                                                                       │
        ┌──────────────────────────────────────────────────────────────┘
        ▼                               
┌───────────────┐              ┌───────────────┐              ┌───────────────┐
│   LAYER 4     │              │   LAYER 5     │              │   LAYER 6     │
│   Scoring     │─────────────▶│   Decision    │─────────────▶│    Output     │
│   (평가층)     │              │   (판단층)     │              │   (출력층)     │
└───────────────┘              └───────────────┘              └───────────────┘
```

### 2.2 레이어별 역할 요약

| Layer | 이름 | 핵심 역할 | 주요 Output |
|-------|------|-----------|-------------|
| **1** | Data Ingest | 외부 데이터 수집 | Raw Data (테마, 뉴스, DART, 가격) |
| **2** | Processing | 데이터 정제 + LLM 키워드 추출 | Theme-Stock Mapping |
| **3** | Analysis | 정량 지표 계산 (수급, 결속력, 추세) | Sector Tier (1/2/3), Metrics |
| **3.5** | **Filtering** ★ | **섹터 성격 규명 + 이원화 필터링** | **필터 통과 종목 + Track Type** |
| **4** | Scoring | 종목 점수화 (Track A/B 가중치 적용) | Scored & Ranked Stock List |
| **5** | Decision | LLM 정성 분석 + 최종 등급 결정 | STRONG_BUY / BUY / WATCH / AVOID |
| **6** | Output | 리포트 생성 + 알림 발송 | CSV, Telegram Message |

### 2.3 레이어 간 의존성

```
┌────────────────────────────────────────────────────────────────────┐
│                      LAYER DEPENDENCY MAP                          │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│   ┌──────────┐                                                    │
│   │  core/   │ ◀──── 모든 레이어가 의존                           │
│   │ (공통)   │                                                    │
│   └────┬─────┘                                                    │
│        │                                                           │
│   ┌────┴────┬─────────────┬─────────────┬─────────────┐          │
│   ▼         ▼             ▼             ▼             ▼          │
│ ingest → processing → analysis → filtering → scoring → decision  │
│  (L1)      (L2)         (L3)       (L3.5)     (L4)      (L5)     │
│                                                           │       │
│                                                           ▼       │
│                                                        output     │
│                                                         (L6)      │
│                                                                    │
│   ┌──────────┐                                                    │
│   │   llm/   │ ◀──── L2, L3.5, L5 에서 사용                       │
│   │ (LLM GW) │                                                    │
│   └──────────┘                                                    │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

## 3. 레이어별 상세 설계

### 3.1 LAYER 1: Data Ingest (데이터 수집층)

#### 목적
> 외부 소스에서 원시 데이터를 가져와 **표준 포맷**으로 저장

#### 구조도

```
┌─────────────────────────────────────────────────────────────────────┐
│                         DATA INGEST LAYER                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │
│  │   Crawler   │  │   Crawler   │  │    API      │  │  Fetcher   │ │
│  │   Naver     │  │    News     │  │    DART     │  │   Price    │ │
│  │   Theme     │  │  Headlines  │  │  Reports    │  │   Data     │ │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └─────┬──────┘ │
│         │                │                │               │        │
│         │   [병렬 실행 - ThreadPoolExecutor]               │        │
│         │                │                │               │        │
│         └────────────────┴────────────────┴───────────────┘        │
│                                   │                                 │
│                                   ▼                                 │
│                        ┌──────────────────┐                        │
│                        │  Raw Data Store  │                        │
│                        │   (Staging DB)   │                        │
│                        └──────────────────┘                        │
└─────────────────────────────────────────────────────────────────────┘
```

#### 모듈 명세

| 모듈명 | 데이터 소스 | 수집 주기 | Output | 재사용성 |
|--------|-------------|-----------|--------|----------|
| `NaverThemeCrawler` | 네이버 금융 테마 | 일 1회 | 테마명, 소속 종목 | 네이버 다른 페이지에도 활용 |
| `NaverNewsSearchCrawler` ★ | 네이버 통합검색 뉴스 | 일 1회 | 헤드라인 + 요약 + 언론사 + 발행일 | 종목명 기반 검색, 기간 필터 지원 |
| `DartApiClient` | DART OpenAPI | 분기 1회 | 분기보고서 '사업의 내용' | DART 전 API 커버 가능 |
| `PriceDataFetcher` | KRX/증권사 API | 일 1회 | OHLCV, 거래대금, 수급 | API 교체 가능 설계 |

---

### 3.2 LAYER 2: Processing (데이터 처리층)

#### 목적
> 원시 데이터를 정제하고, **LLM을 통해 동적 섹터 라벨링** 수행

#### 왜 "동적" 섹터 라벨링인가?

```
┌─────────────────────────────────────────────────────────────────────┐
│  [문제] 고정된 KRX 업종 분류의 한계                                  │
│  ─────────────────────────────────────────────────────────────────  │
│  • 삼성전자: KRX 분류 = "전기전자"                                   │
│  • 하지만 실제로는 "AI반도체", "HBM", "파운드리" 테마에 동시 소속     │
│  • 시장은 "전기전자" 섹터가 아니라 "HBM 테마"로 묶어서 거래함         │
│                                                                     │
│  [해결] 실시간 테마 기반 재분류                                      │
│  ─────────────────────────────────────────────────────────────────  │
│  • Source A: 네이버 테마 (기초 그물망)                               │
│  • Source B: DART 분기보고서 (실체 확인)                             │
│  • Source C: 최근 뉴스 헤드라인 (모멘텀 파악)                        │
│                                                                     │
│  → LLM이 B, C를 분석해 키워드 추출 → A와 합집합 구성                 │
└─────────────────────────────────────────────────────────────────────┘
```

#### 구조도

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PROCESSING LAYER                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                    PREPROCESSOR MODULE                        │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐   │ │
│  │  │  Cleaner    │  │  Normalizer │  │  Deduplicator       │   │ │
│  │  │  (HTML제거) │  │  (정규화)   │  │  (중복제거)          │   │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘   │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                │                                    │
│                                ▼                                    │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                    LLM EXTRACTOR MODULE                       │ │
│  │  ┌─────────────────────┐    ┌─────────────────────────────┐  │ │
│  │  │   Local LLM         │    │   Prompt Template Manager   │  │ │
│  │  │   (Ollama)          │    │                             │  │ │
│  │  │                     │    │   • keyword_extraction.yaml │  │ │
│  │  │   • 키워드 추출     │    │   • theme_mapping.yaml      │  │ │
│  │  │   • 테마 분류       │    │                             │  │ │
│  │  └─────────────────────┘    └─────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                │                                    │
│                                ▼                                    │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                    TAG MAPPER MODULE                          │ │
│  │  ┌─────────────────────┐  ┌─────────────────────────────────┐│ │
│  │  │  Synonym Resolver   │  │  Theme-Stock Mapper             ││ │
│  │  │                     │  │                                 ││ │
│  │  │  "이차전지"         │  │  Theme_ID ←→ Stock_Code 매핑    ││ │
│  │  │   = "2차전지"       │  │  (다대다 관계)                  ││ │
│  │  │   = "배터리"        │  │                                 ││ │
│  │  └─────────────────────┘  └─────────────────────────────────┘│ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                │                                    │
│                                ▼                                    │
│                 ┌────────────────────────────┐                     │
│                 │  Output: Theme Label       │                     │
│                 │  • theme_id               │                     │
│                 │  • type (실체형/기대형)    │                     │
│                 │  • keywords               │                     │
│                 │  • related_stocks         │                     │
│                 └────────────────────────────┘                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 테마 유형 분류

| Type | 명칭 | 근거 | 예시 |
|------|------|------|------|
| **Type 1** | 실체형 | DART 기반 (실제 매출 발생) | 2차전지 소재, 반도체 장비 |
| **Type 2** | 기대형 | News 기반 (MOU, 진출 선언) | AI 신사업, 로봇 |

---

### 3.3 LAYER 3: Analysis (분석층)

#### 목적
> 섹터와 종목의 **정량적 지표**를 계산하고 **Tier 분류**

#### 핵심 지표 정의

```
┌─────────────────────────────────────────────────────────────────────┐
│                         핵심 지표 (Metrics)                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. S_Flow (수급 강도)                                              │
│  ───────────────────────────────────────────────────────────────   │
│  "돈이 들어오고 있는가?"                                            │
│                                                                     │
│  공식: S_Flow = Σ(외인순매수 + 기관순매수 × 1.2) / 시가총액         │
│                                                                     │
│  • 기관에 1.2 가중치: 국내 기관의 정보력 우위 가정                  │
│  • 시총으로 나눔: 대형주/소형주 비교 가능하게 정규화                 │
│                                                                     │
│  ─────────────────────────────────────────────────────────────────  │
│                                                                     │
│  2. S_Breadth (내부 결속력)                                         │
│  ───────────────────────────────────────────────────────────────   │
│  "섹터 내 종목들이 함께 가고 있는가?"                               │
│                                                                     │
│  공식: S_Breadth = (종가 > MA20 종목 수) / 전체 종목 수 × 100      │
│                                                                     │
│  • 대장주만 가고 나머지는 빠지면 → 결속력 낮음 (가짜 상승)          │
│  • 70% 이상이 MA20 위면 → 진짜 섹터 상승                           │
│                                                                     │
│  ─────────────────────────────────────────────────────────────────  │
│                                                                     │
│  3. S_Trend (섹터 추세)                                             │
│  ───────────────────────────────────────────────────────────────   │
│  "추세가 살아있는가?"                                               │
│                                                                     │
│  공식: S_Trend = 정배열 점수(50) + 모멘텀 점수(30) - 과열 패널티(20)│
│                                                                     │
│  • 정배열: MA5 > MA20 > MA60 > MA120                               │
│  • 모멘텀: 최근 20일 수익률                                         │
│  • 과열: RSI > 70이면 패널티                                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### Tier 분류 매트릭스

```
┌─────────────────────────────────────────────────────────────────────┐
│                     SECTOR TIER CLASSIFICATION                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                        S_Trend (추세)                               │
│                    Low/Flat       High                              │
│              ┌─────────────┬─────────────┐                         │
│   S_Flow     │             │             │                         │
│   (수급)     │   TIER 1    │   TIER 2    │                         │
│    High      │  수급 빈집   │  주도 섹터   │                         │
│              │  ★ 선취매   │  눌림목 대기 │                         │
│              ├─────────────┼─────────────┤                         │
│              │             │             │                         │
│    Low       │   무관심    │   TIER 3    │                         │
│              │   (스킵)    │  가짜 상승   │                         │
│              │             │  (진입금지) │                         │
│              └─────────────┴─────────────┘                         │
│                                                                     │
│  [왜곡 검증] 대장주 1개 제외 후에도 S_Flow > 0 이어야 Tier 1,2 유지 │
│  → 실패 시 Tier 3로 강등 (대장주 착시)                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 3.4 LAYER 3.5: Dynamic Filtering (동적 필터링층) ★ 핵심

#### 목적
> 섹터의 성격(실적형 vs 성장형)을 LLM이 판단하고, **맞춤형 필터**를 적용

#### 왜 이 레이어가 필요한가?

```
┌─────────────────────────────────────────────────────────────────────┐
│  핵심 통찰: "모든 섹터에 같은 잣대를 대면 안 된다"                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  [Case 1] 자동차 섹터                                               │
│  ─────────────────────────────────────────────────────────────────  │
│  • 현대차: 영업이익 10조 → 주가 상승 ✓                              │
│  • 기아: 영업이익 8조 → 주가 상승 ✓                                 │
│  • XX모터스: 영업이익 -500억 → 주가 하락 ✗                          │
│                                                                     │
│  → 결론: "숫자가 찍혀야 간다" (실적 기반)                           │
│  → 적용: Hard Filter (영업이익 흑자 필수)                           │
│                                                                     │
│  ─────────────────────────────────────────────────────────────────  │
│                                                                     │
│  [Case 2] 바이오 섹터                                               │
│  ─────────────────────────────────────────────────────────────────  │
│  • 삼성바이오: 영업이익 흑자 → 그냥 대형주                          │
│  • 셀트리온: 영업이익 흑자 → 그냥 대형주                            │
│  • 신생벤처A: 영업이익 -200억, but 임상 3상 → 주가 10배 ★          │
│                                                                     │
│  → 결론: "꿈을 먹고 간다" (기대감 기반)                             │
│  → 적용: Soft Filter (적자 허용, 생존력만 검증)                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 전체 프로세스 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                    LAYER 3.5: DYNAMIC FILTERING                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Input: Tier 1, 2 섹터 리스트 + 소속 종목들 (from Layer 3)          │
│                                                                     │
│  ═══════════════════════════════════════════════════════════════   │
│  STEP 1: 섹터 성격 규명 (SectorClassifier)                         │
│  ═══════════════════════════════════════════════════════════════   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  LLM Prompt (Local - Ollama):                               │   │
│  │  ───────────────────────────────────────────────────────── │   │
│  │  "현재 한국 주식시장에서 [{섹터명}] 섹터의 주가를           │   │
│  │   움직이는 핵심 동력이 무엇인지 분석해라.                   │   │
│  │                                                             │   │
│  │   Type A (실적 기반): 영업이익, PER, 실적 턴어라운드가 중요 │   │
│  │   예: 자동차, 음식료, 은행, 반도체 부품                     │   │
│  │                                                             │   │
│  │   Type B (기대감 기반): 기술력, 임상, 미래 성장성이 중요    │   │
│  │   예: 바이오, AI, 로봇, 우주항공                            │   │
│  │                                                             │   │
│  │   Output: Type A 또는 Type B"                               │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                      │
│                              ▼                                      │
│                    ┌─────────────────┐                             │
│                    │  섹터 Type 결정 │                             │
│                    │   A or B        │                             │
│                    └────────┬────────┘                             │
│                             │                                       │
│  ═══════════════════════════════════════════════════════════════   │
│  STEP 2: 필터 라우팅 (FilterRouter)                                │
│  ═══════════════════════════════════════════════════════════════   │
│                             │                                       │
│              ┌──────────────┴──────────────┐                       │
│              ▼                             ▼                       │
│  ┌─────────────────────┐      ┌─────────────────────┐             │
│  │   TRACK A FILTER    │      │   TRACK B FILTER    │             │
│  │   (실적 기반)        │      │   (성장 기반)        │             │
│  │                     │      │                     │             │
│  │  ┌───────────────┐ │      │  ┌───────────────┐  │             │
│  │  │ [Hard Filter] │ │      │  │ [Soft Filter] │  │             │
│  │  │               │ │      │  │               │  │             │
│  │  │ ✓ 흑자 필수   │ │      │  │ ✓ 적자 허용   │  │             │
│  │  │   (4Q 합산    │ │      │  │               │  │             │
│  │  │    영업익>0)  │ │      │  │ ✓ 생존 검증   │  │             │
│  │  │               │ │      │  │   자본잠식<50%│  │             │
│  │  │ ✓ 부채비율   │ │      │  │   유동비율    │  │             │
│  │  │   < 200%     │ │      │  │   > 100%      │  │             │
│  │  │               │ │      │  │               │  │             │
│  │  │ ✓ PBR < 3.0  │ │      │  │ ✓ R&D > 5%   │  │             │
│  │  │   (과열 제외) │ │      │  │   (가산점)    │  │             │
│  │  └───────────────┘ │      │  └───────────────┘  │             │
│  └──────────┬──────────┘      └──────────┬──────────┘             │
│             │                            │                         │
│             └──────────────┬─────────────┘                         │
│                            ▼                                       │
│  ═══════════════════════════════════════════════════════════════   │
│  STEP 3: 재무 지표 계산 (FinancialAnalyzer)                        │
│  ═══════════════════════════════════════════════════════════════   │
│                            │                                       │
│              ┌─────────────┴─────────────┐                        │
│              ▼                           ▼                        │
│  ┌─────────────────────┐    ┌─────────────────────┐              │
│  │  Track A Metrics    │    │  Track B Metrics    │              │
│  │  ─────────────────  │    │  ─────────────────  │              │
│  │  • 영업이익 YoY     │    │  • 매출액 성장률    │              │
│  │  • ROE              │    │  • R&D 비중         │              │
│  │  • PER              │    │  • 기술특례상장     │              │
│  └─────────────────────┘    └─────────────────────┘              │
│                            │                                       │
│                            ▼                                       │
│                 ┌──────────────────────┐                          │
│                 │  Output:             │                          │
│                 │  • 필터 통과 종목    │                          │
│                 │  • Track Type (A/B)  │                          │
│                 │  • 재무 점수         │                          │
│                 └──────────────────────┘                          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 필터 조건 상세 비교

| 항목 | Track A (Hard Filter) | Track B (Soft Filter) |
|------|----------------------|----------------------|
| **대상 섹터** | 자동차, 음식료, 은행, 반도체부품 | 바이오, AI, 로봇, 우주항공 |
| **영업이익** | 최근 4Q 합산 > 0 (필수) | 적자 허용 |
| **부채비율** | < 200% | 제한 없음 |
| **자본잠식** | - | < 50% (필수) |
| **유동비율** | - | > 100% (필수) |
| **PBR** | < 3.0 (과열 제외) | 제한 없음 |
| **R&D 비중** | - | > 5% (가산점) |
| **거래대금** | 일평균 10억 이상 | 일평균 5억 이상 |
| **철학** | "숫자가 찍혀야 간다" | "꿈을 먹고 간다" |

---

### 3.5 LAYER 4: Scoring (평가층)

#### 목적
> 필터를 통과한 종목에 **Track별 가중치**를 적용하여 최종 점수 산출

#### 가중치 차등 적용 로직

```
┌─────────────────────────────────────────────────────────────────────┐
│                   TRACK별 가중치 차등 적용                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  [Track A - 실적형]                                                 │
│  ─────────────────────────────────────────────────────────────────  │
│  • 시장 논리: "실적이 깡패다"                                       │
│  • 좋은 실적 → 기관/외인 매수 → 주가 상승                          │
│                                                                     │
│  Total Score = (재무 점수 × 0.5) + (차트/수급 점수 × 0.5)          │
│                                                                     │
│  ─────────────────────────────────────────────────────────────────  │
│                                                                     │
│  [Track B - 성장형]                                                 │
│  ─────────────────────────────────────────────────────────────────  │
│  • 시장 논리: "수급이 깡패다"                                       │
│  • 실적 적자 → 재무 분석 무의미 → 세력/테마 수급이 결정             │
│                                                                     │
│  Total Score = (재무 점수 × 0.2) + (차트/수급 점수 × 0.8)          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 점수 구성 요소

| 구분 | Track A (실적형) | Track B (성장형) |
|------|------------------|------------------|
| **재무 점수 (가중치)** | 50% | 20% |
| - 핵심 지표 | 영업이익 YoY, ROE | 매출 성장률, R&D 비중 |
| **차트/수급 점수 (가중치)** | 50% | 80% |
| - 수급 강도 | 외인+기관 순매수 | 좌동 |
| - 이격도 | 현재가 vs MA20 | 좌동 |
| - 거래량 | 최근 거래량 증가율 | 좌동 |
| - 신고가 | 52주 신고가 근접도 | 좌동 |

---

### 3.6 LAYER 5: Decision (판단층)

#### 목적
> LLM 기반 **정성 분석**으로 최종 투자 등급 결정

#### Dual Persona LLM 구조

```
┌─────────────────────────────────────────────────────────────────────┐
│                    DUAL PERSONA LLM ANALYZER                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  [왜 두 개의 페르소나인가?]                                         │
│  • LLM은 긍정 편향 또는 과도한 부정 편향 가능                       │
│  • 상반된 역할의 두 시각을 조합하여 균형 잡힌 판단                  │
│                                                                     │
│  ┌─────────────────────────┐    ┌─────────────────────────┐        │
│  │    PERSONA 1            │    │    PERSONA 2            │        │
│  │    The Skeptic          │    │    Sentiment Reader     │        │
│  │    (냉철한 애널리스트)   │    │    (심리 분석가)         │        │
│  │                         │    │                         │        │
│  │  ▶ Cloud LLM 사용      │    │  ▶ Cloud LLM 사용      │        │
│  │                         │    │                         │        │
│  │  [Input]                │    │  [Input]                │        │
│  │  • 최근 뉴스            │    │  • 커뮤니티 글          │        │
│  │  • 공시 (CB, 유증)      │    │  • 블로그 포스팅        │        │
│  │  • IR 자료              │    │  • 유튜브 댓글          │        │
│  │                         │    │                         │        │
│  │  [분석]                 │    │  [분석]                 │        │
│  │  • 재료 실체 검증       │    │  • 어조 분석            │        │
│  │  • 리스크 발굴          │    │  • 관심도 측정          │        │
│  │  • 지속성 평가          │    │  • 과열/침체 판단       │        │
│  │                         │    │                         │        │
│  │  [Output]               │    │  [Output]               │        │
│  │  ┌─────────────────┐   │    │  ┌─────────────────┐    │        │
│  │  │ 재료 등급       │   │    │  │ 심리 단계       │    │        │
│  │  │ S: 대형 호재    │   │    │  │ 공포: 바닥권    │    │        │
│  │  │ A: 중형 호재    │   │    │  │ 의심: 초기      │    │        │
│  │  │ B: 소형 호재    │   │    │  │ 확신: 중기      │    │        │
│  │  │ C: 재료 없음    │   │    │  │ 환희: 고점      │    │        │
│  │  └─────────────────┘   │    │  └─────────────────┘    │        │
│  └─────────────────────────┘    └─────────────────────────┘        │
│                │                            │                       │
│                └──────────────┬─────────────┘                       │
│                               ▼                                     │
│                  ┌────────────────────────┐                        │
│                  │   DECISION MATRIX      │                        │
│                  │   ENGINE               │                        │
│                  └────────────────────────┘                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### Decision Matrix 상세

| Tier | 재료 등급 | 심리 단계 | 최종 판정 | 설명 |
|------|-----------|-----------|-----------|------|
| 1 | S/A | 공포/의심 | **STRONG_BUY** | 돈은 들어오는데 대중은 모름 |
| 1 | S/A | 확신 | BUY | 초기 상승 중 |
| 2 | A/B | 의심/확신초기 | BUY | 주도 섹터 눌림목 |
| 2 | B/C | 확신후기 | WATCH | 타이밍 늦음 |
| Any | C | Any | WATCH | 재료 불명확 |
| Any | Any | 환희 | **AVOID** | 설거지 위험 |

---

### 3.7 LAYER 6: Output (출력층)

#### 목적
> 최종 결과물 생성 및 배포

#### 출력물 명세

| 출력물 | 파일명 | 내용 |
|--------|--------|------|
| 섹터 랭킹 | `daily_sector_ranking.csv` | Tier, S_Flow, S_Breadth, S_Trend |
| 종목 추천 | `stock_recommendations.csv` | 종목, 섹터, Track, 점수, 판정 |
| 관심 목록 | `watchlist.csv` | WATCH 판정 종목 |
| 실행 로그 | `execution_log.csv` | 실행 시간, 처리량, 에러 |

#### Telegram 알림 형식

```
┌─────────────────────────────────────┐
│ 📊 2025-01-31 Daily Report         │
│                                     │
│ [Top 5 섹터]                        │
│ 1. HBM (Tier 1) ★                  │
│ 2. 조선 (Tier 2)                   │
│ 3. 로봇 (Tier 1) ★                 │
│ 4. 방산 (Tier 2)                   │
│ 5. 2차전지 (Tier 2)                │
│                                     │
│ [STRONG_BUY]                        │
│ • 리오인터내셔널 (화장품/Track A)   │
│   재료: S급 / 심리: 의심            │
│ • 퓨처로봇 (로봇/Track B)           │
│   재료: A급 / 심리: 의심            │
│                                     │
│ [BUY]                               │
│ • ...                               │
└─────────────────────────────────────┘
```

---

## 4. 데이터 흐름도

### 4.1 전체 파이프라인 (End-to-End)

```
                              ┌──────────────────┐
                              │   Daily Trigger  │
                              │   (Scheduler)    │
                              └────────┬─────────┘
                                       │
┌──────────────────────────────────────┼──────────────────────────────────────┐
│  PHASE 1: Data Collection (L1)       │                                      │
│  ────────────────────────────────────┴─────────────────────────────────    │
│  [Parallel] Naver Theme + News + DART + Price                              │
│                                       │                                      │
│                                       ▼                                      │
│                              [ Raw Data Store ]                             │
└──────────────────────────────────────┼──────────────────────────────────────┘
                                       │
┌──────────────────────────────────────┼──────────────────────────────────────┐
│  PHASE 2: Processing (L2)            │                                      │
│  ────────────────────────────────────┴─────────────────────────────────    │
│  Preprocess → LLM Extract (Local) → Tag Mapping                            │
│                                       │                                      │
│                                       ▼                                      │
│                           [ Theme-Stock Mapping ]                           │
└──────────────────────────────────────┼──────────────────────────────────────┘
                                       │
┌──────────────────────────────────────┼──────────────────────────────────────┐
│  PHASE 3: Analysis (L3)              │                                      │
│  ────────────────────────────────────┴─────────────────────────────────    │
│  S_Flow + S_Breadth + S_Trend → Tier Classification                        │
│                                       │                                      │
│                                       ▼                                      │
│                            [ Tier 1, 2 Sectors ]                            │
└──────────────────────────────────────┼──────────────────────────────────────┘
                                       │
┌──────────────────────────────────────┼──────────────────────────────────────┐
│  PHASE 4: Filtering (L3.5) ★         │                                      │
│  ────────────────────────────────────┴─────────────────────────────────    │
│  Sector Type (LLM) → Track A/B Filter → Financial Metrics                  │
│                                       │                                      │
│  ┌────────────────────────────────────────────────────────────────────┐   │
│  │  Example:                                                          │   │
│  │  • 반도체 장비 → Type A → Hard Filter → 흑자 기업만 통과          │   │
│  │  • 바이오 → Type B → Soft Filter → 적자 허용, 생존력만 검증       │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                                       │                                      │
│                                       ▼                                      │
│                       [ Filtered Stocks + Track Type ]                      │
└──────────────────────────────────────┼──────────────────────────────────────┘
                                       │
┌──────────────────────────────────────┼──────────────────────────────────────┐
│  PHASE 5: Scoring (L4)               │                                      │
│  ────────────────────────────────────┴─────────────────────────────────    │
│  Track A: 재무(50%) + 차트(50%)                                            │
│  Track B: 재무(20%) + 차트(80%)                                            │
│                                       │                                      │
│                                       ▼                                      │
│                          [ Top N Scored Stocks ]                            │
└──────────────────────────────────────┼──────────────────────────────────────┘
                                       │
┌──────────────────────────────────────┼──────────────────────────────────────┐
│  PHASE 6: Decision (L5)              │                                      │
│  ────────────────────────────────────┴─────────────────────────────────    │
│  Skeptic (Cloud) + Sentiment (Cloud) → Decision Matrix                     │
│                                       │                                      │
│                                       ▼                                      │
│                    [ STRONG_BUY / BUY / WATCH / AVOID ]                     │
└──────────────────────────────────────┼──────────────────────────────────────┘
                                       │
┌──────────────────────────────────────┼──────────────────────────────────────┐
│  PHASE 7: Output (L6)                │                                      │
│  ────────────────────────────────────┴─────────────────────────────────    │
│  CSV Reports + Telegram + Archive                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 공통 인프라 모듈

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SHARED INFRASTRUCTURE                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │   Config    │  │   Logger    │  │   DB        │  │   LLM       │       │
│  │   Manager   │  │   Service   │  │   Manager   │  │   Gateway   │       │
│  │             │  │             │  │             │  │             │       │
│  │  • YAML기반 │  │  • 구조화   │  │  • 커넥션풀 │  │  • Local/   │       │
│  │  • 환경별   │  │    로깅     │  │  • 트랜잭션 │  │    Cloud    │       │
│  │    설정분리 │  │  • 레벨관리 │  │  • 마이그   │  │    라우팅   │       │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │   Cache     │  │  Scheduler  │  │  Exception  │  │   Metrics   │       │
│  │   Service   │  │   Service   │  │   Handler   │  │  Collector  │       │
│  │             │  │             │  │             │  │             │       │
│  │  • 메모리/  │  │  • Cron식   │  │  • 재시도   │  │  • 실행시간 │       │
│  │    Redis    │  │  • 의존성   │  │  • 알림     │  │  • 성공률   │       │
│  │  • TTL관리  │  │    관리     │  │  • 롤백     │  │  • API호출  │       │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### LLM Gateway 라우팅 규칙

| Task | LLM | 이유 |
|------|-----|------|
| 키워드 추출 | Local (Ollama) | 단순 추출, 빈번 호출, 비용 절감 |
| 섹터 Type A/B 분류 | Local (Ollama) | 패턴 매칭 수준 |
| 재료 심층 분석 (Skeptic) | Cloud (Claude) | 뉘앙스 이해 필요 |
| 심리 분석 (Sentiment) | Cloud (Claude) | 미묘한 어조 파악 |

---

## 6. 디렉토리 구조

```
swing_trading_system/
│
├── config/
│   ├── settings.yaml                # 메인 설정
│   ├── settings.dev.yaml            # 개발 환경
│   ├── settings.prod.yaml           # 운영 환경
│   ├── filter_rules.yaml            # ★ Track A/B 필터 조건
│   └── prompts/                     # LLM 프롬프트 템플릿
│       ├── keyword_extraction.yaml
│       ├── sector_classification.yaml  # ★ Type A/B 분류용
│       ├── skeptic_analysis.yaml
│       └── sentiment_analysis.yaml
│
├── src/
│   ├── __init__.py
│   │
│   ├── core/                        # 공통 모듈
│   │   ├── config.py
│   │   ├── logger.py
│   │   ├── database.py
│   │   ├── cache.py
│   │   ├── exceptions.py
│   │   └── interfaces.py
│   │
│   ├── ingest/                      # Layer 1
│   │   ├── base.py
│   │   ├── naver_theme.py
│   │   ├── news_crawler.py          # 레거시
│   │   ├── naver_news_search.py     # ★ v3.1 뉴스 검색 (종목명 기반, 요약 포함)
│   │   ├── dart_client.py
│   │   └── price_fetcher.py
│   │
│   ├── processing/                  # Layer 2
│   │   ├── preprocessor.py
│   │   ├── llm_extractor.py
│   │   └── tag_mapper.py
│   │
│   ├── analysis/                    # Layer 3
│   │   ├── metrics/
│   │   │   ├── flow.py
│   │   │   ├── breadth.py
│   │   │   └── trend.py
│   │   ├── correlation.py
│   │   └── tier_classifier.py
│   │
│   ├── filtering/                   # ★ Layer 3.5 (신규)
│   │   ├── __init__.py
│   │   ├── sector_classifier.py     # LLM Type A/B 분류
│   │   ├── filter_router.py         # 필터 라우팅
│   │   ├── track_a_filter.py        # Hard Filter
│   │   ├── track_b_filter.py        # Soft Filter
│   │   └── financial_analyzer.py    # 재무 지표 계산
│   │
│   ├── scoring/                     # Layer 4
│   │   ├── stock_scorer.py
│   │   └── weight_config.py
│   │
│   ├── decision/                    # Layer 5
│   │   ├── llm_analyzer.py
│   │   ├── personas/
│   │   │   ├── skeptic.py
│   │   │   └── sentiment.py
│   │   └── decision_engine.py
│   │
│   ├── output/                      # Layer 6
│   │   ├── report_generator.py
│   │   ├── telegram_bot.py
│   │   └── archive.py
│   │
│   └── llm/                         # LLM Gateway
│       ├── gateway.py
│       ├── local_client.py
│       └── cloud_client.py
│
├── tests/
│   ├── unit/
│   │   ├── test_filtering/          # ★ 필터링 테스트
│   │   │   ├── test_sector_classifier.py
│   │   │   ├── test_track_a_filter.py
│   │   │   └── test_track_b_filter.py
│   │   └── ...
│   └── integration/
│
├── scripts/
│   ├── run_daily.py
│   └── backtest.py
│
└── requirements.txt
```

---

## 7. 핵심 인터페이스 정의

### 7.1 StockFilter Interface (Layer 3.5용) ★

```python
from abc import ABC, abstractmethod
from dataclasses import dataclass
from typing import List

@dataclass
class FilterResult:
    passed: bool
    stock_code: str
    reason: str           # 통과/탈락 사유
    metrics: dict         # 계산된 지표들

class StockFilter(ABC):
    """모든 필터의 기본 인터페이스"""
    
    @abstractmethod
    def apply(self, stock: dict) -> FilterResult:
        """단일 종목 필터 적용"""
        pass
    
    @abstractmethod
    def apply_batch(self, stocks: List[dict]) -> List[FilterResult]:
        """복수 종목 일괄 필터 적용"""
        pass
    
    @abstractmethod
    def get_filter_name(self) -> str:
        """필터 이름 반환 (예: 'TrackAFilter')"""
        pass
    
    @abstractmethod
    def get_conditions(self) -> dict:
        """필터 조건 반환 (설명/로깅용)"""
        pass
```

### 7.2 SectorClassifier Interface (Layer 3.5용) ★

```python
from enum import Enum

class SectorType(Enum):
    TYPE_A = "earnings_driven"   # 실적 기반
    TYPE_B = "growth_driven"     # 성장 기반

class SectorClassifier:
    """섹터 성격 분류기 (LLM 기반)"""
    
    def classify(self, sector_name: str) -> SectorType:
        """
        섹터명을 입력받아 Type A/B 반환
        
        Args:
            sector_name: 섹터명 (예: "반도체 장비", "바이오시밀러")
        
        Returns:
            SectorType.TYPE_A or SectorType.TYPE_B
        """
        pass
    
    def classify_batch(self, sectors: List[str]) -> dict[str, SectorType]:
        """복수 섹터 일괄 분류 (비용 최적화)"""
        pass
```

### 7.3 Scorer Interface

```python
from enum import Enum

class TrackType(Enum):
    TRACK_A = "earnings_driven"
    TRACK_B = "growth_driven"

@dataclass
class ScoreResult:
    stock_code: str
    track_type: TrackType
    financial_score: float      # 재무 점수 (0-100)
    technical_score: float      # 차트/수급 점수 (0-100)
    total_score: float          # 가중 합산 점수
    rank: int

class Scorer(ABC):
    @abstractmethod
    def score(self, stock: dict, track_type: TrackType) -> ScoreResult:
        pass
    
    @abstractmethod
    def get_weight_config(self, track_type: TrackType) -> dict:
        """Track별 가중치 반환"""
        # Track A: {'financial': 0.5, 'technical': 0.5}
        # Track B: {'financial': 0.2, 'technical': 0.8}
        pass
```

---

## 8. 데이터 모델

### 8.1 Theme (테마/섹터)

```python
@dataclass
class Theme:
    theme_id: str
    name: str
    theme_type: str        # "실체형" or "기대형"
    sector_type: str       # "A" or "B" (LLM 분류 결과) ★
    keywords: List[str]
    leader_stock_code: str
    related_stocks: List[str]
    tier: int              # 1, 2, or 3
    
    # Metrics
    s_flow: float
    s_breadth: float
    s_trend: float
    
    last_updated: datetime
```

### 8.2 Stock (종목)

```python
@dataclass
class Stock:
    stock_code: str
    name: str
    
    # 소속 정보
    themes: List[str]          # theme_ids
    track_type: TrackType      # A or B ★
    
    # 재무 데이터
    operating_profit_4q: float
    debt_ratio: float
    pbr: float
    current_ratio: float
    capital_impairment: float
    rd_ratio: float
    
    # 필터 결과 ★
    filter_passed: bool
    filter_reason: str
    
    # 점수
    financial_score: float
    technical_score: float
    total_score: float
    rank: int
    
    # 최종 판정
    material_grade: str        # S/A/B/C
    sentiment_stage: str       # 공포/의심/확신/환희
    recommendation: str        # STRONG_BUY/BUY/WATCH/AVOID
```

---

## 9. 실행 파이프라인

### 9.1 Orchestrator 핵심 로직

```python
class DailyPipeline:
    def run(self) -> DailySnapshot:
        # Step 1: Data Collection (병렬)
        raw_data = self.ingest_layer.collect_all()
        
        # Step 2: Processing
        theme_mapping = self.processing_layer.process(raw_data)
        
        # Step 3: Analysis
        sector_tiers = self.analysis_layer.analyze(theme_mapping)
        
        # Step 4: Filtering ★ (핵심)
        filtered_stocks = self.filtering_layer.filter(sector_tiers)
        # → 섹터별 Type 분류 → Track A/B 필터 적용
        
        # Step 5: Scoring
        scored_stocks = self.scoring_layer.score(filtered_stocks)
        # → Track별 가중치 적용
        
        # Step 6: Decision (Top N만)
        top_n = scored_stocks[:self.config.top_n]
        decisions = self.decision_layer.decide(top_n)
        # → Cloud LLM 호출 (비용 최적화)
        
        # Step 7: Output
        return self.output_layer.generate(decisions)
```

---

## 10. 확장 포인트 및 에러 처리

### 10.1 확장 포인트

| 확장 포인트 | 현재 구현 | 확장 가능성 |
|-------------|-----------|-------------|
| **DataFetcher** | Naver, DART, News | Yahoo Finance, Bloomberg |
| **Filter** | Track A/B (2가지) | Track C (배당형), Track D (턴어라운드) |
| **LLMClient** | Ollama, Claude | GPT, Gemini, 자체 모델 |
| **Scorer** | Rule-based | ML 기반, 앙상블 |
| **Output** | CSV, Telegram | Slack, Dashboard |

### 10.2 에러 처리 전략

| Layer | 에러 유형 | 처리 방식 |
|-------|-----------|-----------|
| L1 (Ingest) | 크롤링 실패 | 캐시된 이전 데이터 사용 |
| L2 (Processing) | LLM 추출 실패 | 3회 재시도 후 스킵 |
| L3 (Analysis) | 지표 계산 실패 | 해당 섹터 제외 |
| **L3.5 (Filtering)** | LLM 분류 실패 | **Type A (보수적) 적용** ★ |
| L5 (Decision) | Cloud LLM 실패 | WATCH 등급 부여 |

---

## 11. 용어 정의

| 용어 | 정의 |
|------|------|
| **S_Flow** | 수급 강도. 외인+기관 순매수를 시총으로 정규화 |
| **S_Breadth** | 내부 결속력. 섹터 내 MA20 위 종목 비율 |
| **S_Trend** | 섹터 추세. 정배열 + 모멘텀 - 과열 |
| **Tier 1** | 수급 빈집. 돈은 들어오는데 차트는 아직 |
| **Tier 2** | 주도 섹터. 돈도 들어오고 차트도 상승 |
| **Tier 3** | 가짜 상승. 대장주만 상승 |
| **Track A** | 실적 기반 필터/스코어링 (Hard, 50:50) |
| **Track B** | 성장 기반 필터/스코어링 (Soft, 20:80) |
| **Skeptic** | 재료 분석 LLM 페르소나 |
| **Sentiment Reader** | 심리 분석 LLM 페르소나 (A+B+C 통합) |

---

## 12. 다음 단계 (Next Steps)

1. **DB 스키마 설계** - 각 Entity의 테이블 구조 확정
2. **Core 모듈 구현** - Config, Logger, DB Manager
3. **Filtering 모듈 구현** ★ - SectorClassifier, Track Filters
4. **단위 테스트 작성** - 특히 필터링 로직 테스트
5. **Data Ingest 모듈 구현** - Crawler, API Client

---

---

## 13. Sentiment Reader A+B+C 통합 분석 (v2.1 추가)

### 13.1 배경

기존 Sentiment Reader는 커뮤니티 글만으로 심리를 분석했으나, 실제로는 다양한 소스의 통합 분석이 필요합니다.

### 13.2 A+B+C 접근법

```
┌─────────────────────────────────────────────────────────────────────┐
│                   SENTIMENT READER A+B+C 통합                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │
│  │   A: 뉴스 기반   │  │  B: 토론방 기반  │  │  C: 가격 기반   │    │
│  │   (30% 가중치)   │  │   (40% 가중치)   │  │  (30% 가중치)   │    │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤    │
│  │ Input:          │  │ Input:          │  │ Input:          │    │
│  │ • 뉴스 헤드라인  │  │ • 토론방 글     │  │ • RSI           │    │
│  │ • 뉴스 수량     │  │ • 공감/비공감   │  │ • 1주/1개월 수익률│   │
│  │                 │  │ • 조회수        │  │ • 거래량 비율   │    │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤    │
│  │ 분석:           │  │ 분석:           │  │ 분석:           │    │
│  │ • 뉴스 어조     │  │ • 공감 비율     │  │ • 과매수/과매도  │    │
│  │ • 관심도 proxy  │  │ • 키워드 매칭   │  │ • 모멘텀        │    │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤    │
│  │ Output:         │  │ Output:         │  │ Output:         │    │
│  │ news_stage      │  │ discussion_stage│  │ price_stage     │    │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘    │
│           │                    │                    │              │
│           └────────────────────┼────────────────────┘              │
│                                ▼                                   │
│                    ┌─────────────────────┐                        │
│                    │   가중 평균 조합     │                        │
│                    │   A×0.3 + B×0.4 + C×0.3 │                    │
│                    └──────────┬──────────┘                        │
│                               ▼                                    │
│                    ┌─────────────────────┐                        │
│                    │  최종 sentiment_stage │                       │
│                    │  FEAR/DOUBT/        │                        │
│                    │  CONVICTION/EUPHORIA │                        │
│                    └─────────────────────┘                        │
└─────────────────────────────────────────────────────────────────────┘
```

### 13.3 새로 추가된 모듈

| 모듈 | 파일 | 용도 |
|------|------|------|
| **DiscussionCrawler** | `src/ingest/discussion_crawler.py` | 네이버 금융 토론방 크롤링 |

### 13.4 섹터 라벨링 로직 개선

```
┌─────────────────────────────────────────────────────────────────────┐
│                   SECTOR LABELING v2.1                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  [AS-IS] 모든 소스 가중 합산                                        │
│  ────────────────────────────────────────────────────────────────   │
│  primary_sector = weighted_sum(테마 + DART + 뉴스 + LLM)            │
│                                                                     │
│  [TO-BE] v3.0 방식                                                  │
│  ────────────────────────────────────────────────────────────────   │
│  theme_tags = 네이버 테마명 그대로 사용 (N:M 관계)                  │
│  business_summary = DART 사업개요 → LLM 요약                        │
│  news_summary = 뉴스 헤드라인 → LLM 요약                            │
│                                                                     │
│  장점:                                                              │
│  • 섹터(테마) 분류와 부가정보(LLM요약)를 분리                       │
│  • 1종목 N섹터 관계 자연스럽게 지원                                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

---

## 14. v3.0 아키텍처 변경사항 (2026-02-01)

### 14.1 핵심 변경: SectorCategory Enum 제거

기존에는 테마를 `SectorCategory` Enum (예: `SEMICONDUCTOR`, `SECONDARY_BATTERY`)으로 관리했으나, 네이버 테마명 문자열을 직접 사용하는 방식으로 변경되었습니다.

```
┌─────────────────────────────────────────────────────────────────────────┐
│  [AS-IS] v2.x                                                           │
│  ─────────────────────────────────────────────────────────────────────  │
│  • SectorCategory Enum으로 제한된 섹터 (20개 정도)                       │
│  • 새 테마 추가 시 코드 수정 필요                                        │
│  • 1:N 관계 (종목 → 하나의 섹터)                                        │
│                                                                         │
│  [TO-BE] v3.0                                                           │
│  ─────────────────────────────────────────────────────────────────────  │
│  • 네이버 테마명 문자열 그대로 사용 (예: "반도체", "2차전지", "AI")       │
│  • 새 테마 자동 지원 (코드 수정 불필요)                                  │
│  • N:M 관계 (종목 ↔ 여러 테마)                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 14.2 모듈 구조 변경

| AS-IS (v2.x) | TO-BE (v3.0) | 변경 사항 |
|--------------|--------------|-----------|
| `processing/sector_labeler.py` | **삭제** | `sector/classifier.py`로 이동 |
| `sector/classifier.py` | `StockThemeAnalyzer` | 테마 데이터셋 구축 |
| `sector/type_analyzer.py` | `SectorTypeAnalyzer` | 테마명 문자열로 Type A/B 분류 |
| `sector/prioritizer.py` | `SectorPrioritizer` | `ThemeMetrics` 클래스 사용 |
| `stock/selector.py` | `CandidateSelector` | `sector: str` 필드 (문자열) |

### 14.3 핵심 데이터 클래스 (v3.0)

```python
# 테마 데이터 (v3.0)
@dataclass
class ThemeData:
    theme_id: str           # "theme_001"
    theme_name: str         # "반도체" (네이버 테마명 그대로)
    change_rate: float      # 등락률
    stock_count: int        # 소속 종목 수
    stock_codes: list[str]  # 소속 종목 코드

# 종목 분석 데이터 (v3.0)
@dataclass
class StockAnalysisData:
    stock_code: str
    stock_name: str
    theme_tags: list[str]   # ["반도체", "AI", "HBM"] - N개 테마 소속 가능
    business_summary: str   # LLM 사업 요약
    news_summary: str       # LLM 뉴스 요약

# 테마 지표 (v3.0)
@dataclass
class ThemeMetrics:
    theme_name: str         # "반도체" (문자열)
    sector_type: SectorType # TYPE_A or TYPE_B
    stock_count: int
    change_rate: float
    s_flow: float
    s_breadth: float
    s_trend: float
    news_count: int
    hot_keywords: list[str]

# 후보 종목 결과 (v3.0)
@dataclass
class CandidateResult:
    stock_code: str
    stock_name: str
    sector: str             # "반도체" (Enum → 문자열)
    sector_rank: int
    track_type: TrackType
    # ... 나머지 필드 동일
```

### 14.4 파이프라인 단계 (v3.0)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Stage 0: 데이터 수집 (StageRunner)                                      │
│  ─────────────────────────────────────────────────────────────────────  │
│  • 0-1: 테마 크롤링 (NaverThemeCrawler)                                  │
│  • 0-2: 주가 수집 (PriceFetcher)                                        │
│  • 0-3: 재무 수집 (DartClient)                                          │
│  • 0-4: 수급/펀더멘탈 수집 (pykrx)                                       │
│  • 0-5: 뉴스 수집 (NaverNewsSearchCrawler) ★ v3.1                       │
│         - 종목명 기반 검색, 요약 포함, 4초 딜레이                         │
│  • 0-6: DART 사업개요 수집                                               │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Stage 1: 섹터 분류 (StockThemeAnalyzer)                                 │
│  ─────────────────────────────────────────────────────────────────────  │
│  INPUT:                                                                 │
│    - themes: 네이버 테마 목록                                            │
│    - theme_stocks: 테마-종목 매핑                                        │
│    - dart_data: {종목코드: DART 사업개요 텍스트}                          │
│    - news_data: {종목코드: [뉴스 기사]}                                   │
│                                                                         │
│  OUTPUT:                                                                │
│    - theme_stocks_map: {테마명: [종목코드,...]}                          │
│    - stock_themes_map: {종목코드: [테마명,...]}  ← N:M 관계              │
│    - stocks_data: StockAnalysisData[]                                   │
│        - stock_code, stock_name                                         │
│        - theme_tags: [테마명,...]  ← 섹터 (N개 가능)                     │
│        - business_summary: DART LLM 요약                                │
│        - news_summary: 뉴스 LLM 요약                                    │
│                                                                         │
│  핵심: 1종목이 여러 섹터(테마)에 속할 수 있음 (N:M)                       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Stage 2: 섹터 타입 분류 (SectorTypeAnalyzer)                            │
│  ─────────────────────────────────────────────────────────────────────  │
│  • Input: theme_names (문자열 리스트)                                    │
│  • Output: {테마명: SectorType} (예: {"반도체": TYPE_B, "은행": TYPE_A}) │
│  • 키워드 기반 + LLM 분류                                                │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Stage 3: 섹터 우선순위 (SectorPrioritizer)                              │
│  ─────────────────────────────────────────────────────────────────────  │
│  • Input: ThemeMetrics[] (S_Flow, S_Breadth, S_Trend, 뉴스 수)          │
│  • Output: 상위 N개 테마 (점수순 + LLM 전망 분석)                        │
│  • 부정 테마 배제 (LLM negative 판정)                                    │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Stage 4: 종목 선정 (CandidateSelector)                                  │
│  ─────────────────────────────────────────────────────────────────────  │
│  • Input: stocks_data[], sector_type_map: {테마명: SectorType}          │
│  • Process: Track A/B 필터 → 점수화 → 순위                              │
│  • Output: CandidateResult[] (테마당 N개, 전체 최대 M개)                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Stage 5: 최종 검증 (MaterialAnalyzer + SentimentAnalyzer)               │
│  ─────────────────────────────────────────────────────────────────────  │
│  • 5-1: 커뮤니티 수집 (선정 종목만)                                      │
│  • 5-2: 재료 분석 (Skeptic - Claude)                                    │
│  • 5-3: 심리 분석 (Sentiment - Claude)                                  │
│  • 5-4: DecisionEngine → STRONG_BUY / BUY / WATCH / AVOID              │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Stage 6: 아웃풋 (StageSaver + ReportGenerator + TelegramNotifier)       │
│  ─────────────────────────────────────────────────────────────────────  │
│  • 단계별 결과 JSON 저장                                                 │
│  • 일일 리포트 생성                                                      │
│  • 텔레그램 메시지 발송                                                  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 14.5 하위 호환성

기존 코드와의 호환성을 위해 deprecated 별칭이 유지됩니다:

```python
# sector/__init__.py
from src.sector.classifier import SectorClassifier  # deprecated → StockThemeAnalyzer
from src.sector.prioritizer import SectorMetrics    # deprecated → ThemeMetrics

# stock/selector.py
def get_by_sector(...)  # deprecated → get_by_theme()
```

### 14.6 테스트 커버리지 (v3.0)

| 모듈 | 테스트 파일 | 테스트 수 |
|------|------------|----------|
| `sector/classifier.py` | `tests/sector/test_classifier.py` | 31개 |
| `sector/type_analyzer.py` | `tests/sector/test_type_analyzer.py` | 27개 |
| `sector/prioritizer.py` | `tests/sector/test_prioritizer.py` | 23개 |
| `stock/selector.py` | `tests/stock/test_selector.py` | 20개 |
| `output/*` | `tests/test_output.py` | 37개 |
| **총계** | | **138개** |

---

*문서 버전: 3.0*
*작성일: 2026-02-01*
*주요 변경: SectorCategory Enum 제거, 테마명 문자열 직접 사용, N:M 종목-테마 관계, 모듈 구조 개편*

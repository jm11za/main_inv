# Stock Analysis Pipeline Architecture v2.0

## 핵심 원칙

### Top-Down 섹터 중심 접근
- 종목 분석 전에 **섹터를 먼저 분석하고 필터링**
- 상위 섹터의 종목만 심층 분석하여 **리소스 효율화**
- LLM은 **섹터 분석**과 **최종 재검증**에 집중

---

## 파이프라인 흐름도

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              [사전 수집] 전체 데이터                              │
│                                                                                 │
│   네이버 테마 ─┬─ 테마별 종목 ─┬─ 주가 데이터 ─┬─ 재무 데이터 ─┬─ 종목별 뉴스    │
│    (30개)     │   (421개)    │   (pykrx)    │  (DART/pykrx) │   (크롤링)      │
└───────────────┴──────────────┴──────────────┴───────────────┴─────────────────┘
                                      │
                                      ▼
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                 PROCESSING                      ┃         OUTPUT FLOW         ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╋━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃                                                 ┃                             ┃
┃  ┌─────────────────────────────────────────┐   ┃   ┌─────────────────────┐   ┃
┃  │  ① 섹터 분류                             │   ┃   │  [1] 섹터 분류 결과  │   ┃
┃  │                                         │   ┃   │                     │   ┃
┃  │  • 섹터: 네이버 테마명 그대로 사용        │ ──╋─▶│  • 종목-섹터 맵핑    │   ┃
┃  │  • 1종목 N섹터 관계 (N:M)               │   ┃   │    (N:M 관계)       │   ┃
┃  │  • 부가정보: DART/뉴스 LLM 요약          │   ┃   │  • 섹터별 종목 수    │   ┃
┃  └─────────────────────────────────────────┘   ┃   └──────────┬──────────┘   ┃
┃                      │                         ┃              │ 저장          ┃
┃                      ▼                         ┃              ▼              ┃
┃  ┌─────────────────────────────────────────┐   ┃   ┌─────────────────────┐   ┃
┃  │  ② 섹터 Type A/B 분류                    │   ┃   │  [2] Type 분류 결과  │   ┃
┃  │                                         │   ┃   │                     │   ┃
┃  │  • LLM: 섹터 특성 분석                   │ ──╋─▶│  • 섹터별 Type       │   ┃
┃  │  • Type A (실적형) / Type B (성장형)     │   ┃   │  • 분류 근거         │   ┃
┃  │                                         │   ┃   │                     │   ┃
┃  └─────────────────────────────────────────┘   ┃   └──────────┬──────────┘   ┃
┃                      │                         ┃              │ 저장          ┃
┃                      ▼                         ┃              ▼              ┃
┃  ┌─────────────────────────────────────────┐   ┃   ┌─────────────────────┐   ┃
┃  │  ③ 섹터 우선순위 결정                    │   ┃   │  [3] 우선순위 결과   │   ┃
┃  │                                         │   ┃   │                     │   ┃
┃  │  [집계 데이터]                           │   ┃   │  • 섹터 순위표       │   ┃
┃  │  • S_Flow (수급)                        │   ┃   │  • 각 섹터 점수      │   ┃
┃  │  • S_Breadth (결속력)                   │ ──╋─▶│  • LLM 분석 코멘트   │   ┃
┃  │  • S_Trend (추세)                       │   ┃   │  • 배제 섹터 목록    │   ┃
┃  │  • 섹터 내 재무 상태                     │   ┃   │                     │   ┃
┃  │                                         │   ┃   └──────────┬──────────┘   ┃
┃  │  [LLM 분석]                             │   ┃              │ 저장          ┃
┃  │  • Type A: 실적 전망 평가                │   ┃              ▼              ┃
┃  │  • Type B: 모멘텀/이슈 강도 평가         │   ┃                             ┃
┃  │                                         │   ┃                             ┃
┃  │  [결과]                                  │   ┃                             ┃
┃  │  • 섹터 순위 결정                        │   ┃                             ┃
┃  │  • 하위 섹터 배제                        │   ┃                             ┃
┃  │  → 상위 N개 섹터만 통과                  │   ┃                             ┃
┃  └─────────────────────────────────────────┘   ┃                             ┃
┃                      │                         ┃                             ┃
┃            ┌─────────┴─────────┐               ┃                             ┃
┃            ▼                   ▼               ┃                             ┃
┃      [상위 섹터]          [하위 섹터]           ┃                             ┃
┃       (~5개)              (배제)               ┃                             ┃
┃            │                                   ┃                             ┃
┃            ▼                                   ┃                             ┃
┃  ┌─────────────────────────────────────────┐   ┃   ┌─────────────────────┐   ┃
┃  │  ④ 종목 선정                             │   ┃   │  [4] 종목 선정 결과  │   ┃
┃  │                                         │   ┃   │                     │   ┃
┃  │  • Track A/B 필터링                     │   ┃   │  • 필터 통과 종목    │   ┃
┃  │  • 종목 점수화                          │ ──╋─▶│  • 종목별 점수       │   ┃
┃  │  • 섹터별 상위 종목 선정                 │   ┃   │  • 필터 탈락 사유    │   ┃
┃  │                                         │   ┃   │                     │   ┃
┃  │  → 투자 후보 종목 (~15개)               │   ┃   └──────────┬──────────┘   ┃
┃  └─────────────────────────────────────────┘   ┃              │ 저장          ┃
┃                      │                         ┃              ▼              ┃
┃                      ▼                         ┃                             ┃
┃  ┌─────────────────────────────────────────┐   ┃   ┌─────────────────────┐   ┃
┃  │  ⑤ 종목 재검증                           │   ┃   │  [5] 재검증 결과     │   ┃
┃  │                                         │   ┃   │                     │   ┃
┃  │  [여기서 수집]                           │   ┃   │  • 재료 등급 (S~C)   │   ┃
┃  │  • 커뮤니티 반응 크롤링                  │   ┃   │  • 심리 단계         │   ┃
┃  │                                         │ ──╋─▶│  • LLM 분석 상세     │   ┃
┃  │  [LLM 심층 분석]                         │   ┃   │  • 최종 판정         │   ┃
┃  │  • Skeptic: 재료 분석                   │   ┃   │    (BUY/WATCH/AVOID) │   ┃
┃  │  • Sentiment: 심리 분석                 │   ┃   │                     │   ┃
┃  │                                         │   ┃   └──────────┬──────────┘   ┃
┃  │  → 최종 판정                            │   ┃              │ 저장          ┃
┃  └─────────────────────────────────────────┘   ┃              ▼              ┃
┃                                                 ┃                             ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              [최종 OUTPUT]                                       │
│                                                                                 │
│                           ┌────────────┬────────────┐                           │
│                           ▼            ▼            ▼                           │
│                     ┌──────────┐ ┌──────────┐ ┌──────────┐                      │
│                     │ Telegram │ │  Local   │ │   Log    │                      │
│                     │   전송   │ │  저장    │ │   저장   │                      │
│                     └──────────┘ └──────────┘ └──────────┘                      │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 단계별 상세

### ① 섹터 분류 (Stage 1)
| 항목 | 내용 |
|------|------|
| 입력 | 네이버 테마, DART 사업보고서, 뉴스 헤드라인 |
| 처리 | 테마-종목 N:M 매핑 + 부가정보 LLM 요약 |
| 출력 | `StockAnalysisData` - 종목별 섹터(N개) + 사업요약 + 뉴스요약 |
| LLM | Ollama (DART/뉴스 요약) |

**Stage 1 상세:**
```
INPUT:
  - themes: 네이버 테마 목록
  - theme_stocks: 테마-종목 매핑
  - dart_data: {종목코드: DART 사업개요 텍스트}
  - news_data: {종목코드: [뉴스 기사]}

OUTPUT:
  - theme_stocks_map: {테마명: [종목코드,...]}
  - stock_themes_map: {종목코드: [테마명,...]}  ← N:M 관계
  - stocks_data: StockAnalysisData[]
      - stock_code, stock_name
      - theme_tags: [테마명,...]  ← 섹터 (N개 가능)
      - business_summary: LLM 사업 요약
      - news_summary: LLM 뉴스 요약
```

### ② 섹터 Type A/B 분류
| 항목 | 내용 |
|------|------|
| 입력 | 섹터 목록 |
| 처리 | 각 섹터의 투자 성격 판단 |
| 출력 | `SectorType` - A(실적형) / B(성장형) |
| LLM | Ollama (섹터 특성 분석) |

**Type A (실적형)**: 자동차, 은행, 건설, 유통, 철강, 화학
- "숫자가 찍혀야 주가가 간다"
- 영업이익, PER, 실적 턴어라운드 중요

**Type B (성장형)**: 바이오, AI, 로봇, 우주항공, 2차전지
- "꿈을 먹고 주가가 간다"
- 기술력, 파이프라인, 미래 성장성 중요

### ③ 섹터 우선순위 결정
| 항목 | 내용 |
|------|------|
| 입력 | 섹터별 집계 데이터 (S_Flow, S_Breadth, S_Trend, 재무) |
| 처리 | Type별 가중치 적용 + LLM 전망 분석 |
| 출력 | 섹터 순위 + 하위 섹터 배제 |
| LLM | Ollama (Type A: 실적 전망, Type B: 모멘텀 평가) |

**Type A 가중치**: S_Flow(40%) + 실적(40%) + S_Breadth(20%)
**Type B 가중치**: S_Trend(40%) + 이슈강도(40%) + S_Flow(20%)

### ④ 종목 선정
| 항목 | 내용 |
|------|------|
| 입력 | 상위 섹터 내 종목 |
| 처리 | Track A/B 필터링 + 점수화 |
| 출력 | 투자 후보 종목 (~15개) |
| LLM | 없음 (규칙 기반) |

### ⑤ 종목 재검증
| 항목 | 내용 |
|------|------|
| 입력 | 후보 종목 + 커뮤니티 반응 (여기서 수집) |
| 처리 | Skeptic(재료) + Sentiment(심리) 분석 |
| 출력 | 최종 판정 (STRONG_BUY/BUY/WATCH/AVOID) |
| LLM | Claude CLI (심층 분석) |

---

## LLM 사용 시점

| 단계 | LLM | 용도 | 호출 횟수 |
|------|-----|------|----------|
| ① 섹터 분류 | Ollama | DART 사업요약 + 뉴스 요약 | ~421회 (종목당 1회) |
| ② Type 분류 | Ollama | 섹터 특성 판단 | ~30회 (섹터당 1회) |
| ③ 우선순위 | Ollama | 전망/모멘텀 평가 | ~30회 (섹터당 1회) |
| ⑤ 재검증 | Claude CLI | 재료/심리 분석 | ~15회 (후보당 1회) |

---

## 출력 구조

```
outputs/
├── stages/                          # 각 단계별 결과
│   ├── 01_sector_classify.json      # ① 섹터 분류
│   ├── 02_sector_type.json          # ② Type A/B
│   ├── 03_sector_priority.json      # ③ 우선순위
│   ├── 04_stock_selection.json      # ④ 종목 선정
│   └── 05_stock_verify.json         # ⑤ 재검증
│
├── reports/
│   ├── daily/
│   │   └── 2026-02-01_full.json     # 전체 종합
│   │
│   └── telegram/
│       └── 2026-02-01_summary.txt   # 텔레그램용 요약
│
└── logs/
    └── 2026-02-01.log               # 실행 로그
```

---

## 모듈 구조

```
src/
├── ingest/                 # 데이터 수집 (기존 유지)
│   ├── naver_theme.py
│   ├── price_fetcher.py
│   ├── dart_client.py
│   ├── news_crawler.py
│   └── community_crawler.py  # ⑤에서만 사용
│
├── sector/                 # 섹터 분석 (신규)
│   ├── __init__.py
│   ├── classifier.py       # ① 섹터 분류
│   ├── type_analyzer.py    # ② Type A/B 분류
│   └── prioritizer.py      # ③ 우선순위 결정
│
├── stock/                  # 종목 분석 (신규/리팩토링)
│   ├── __init__.py
│   ├── filter.py           # ④ Track A/B 필터
│   ├── scorer.py           # ④ 점수화
│   └── selector.py         # ④ 후보 선정
│
├── verify/                 # 재검증 (신규)
│   ├── __init__.py
│   ├── material_analyzer.py  # ⑤ Skeptic
│   ├── sentiment_analyzer.py # ⑤ Sentiment
│   └── decision_engine.py    # ⑤ 최종 판정
│
├── output/                 # 출력 (리팩토링)
│   ├── __init__.py
│   ├── stage_saver.py      # 단계별 저장
│   ├── report_generator.py # 종합 리포트
│   └── telegram_sender.py  # 텔레그램 전송
│
├── core/                   # 공통 (기존 유지)
│   ├── interfaces.py
│   ├── config.py
│   ├── logger.py
│   └── exceptions.py
│
├── llm/                    # LLM 클라이언트 (기존 유지)
│   ├── ollama_client.py
│   └── cli_client.py
│
└── orchestrator/           # 오케스트레이터 (리팩토링)
    ├── __init__.py
    └── pipeline.py         # 메인 파이프라인
```

---

## 설정 (config.yaml)

```yaml
pipeline:
  top_sectors: 5              # 상위 섹터 수
  candidates_per_sector: 3    # 섹터당 후보 종목 수
  max_candidates: 15          # 최대 후보 종목 수

sector:
  type_a_weights:
    s_flow: 0.4
    earnings: 0.4
    s_breadth: 0.2
  type_b_weights:
    s_trend: 0.4
    momentum: 0.4
    s_flow: 0.2

filter:
  track_a:
    min_operating_profit: 0
    max_debt_ratio: 200
    max_pbr: 3.0
    min_trading_value: 1000000000  # 10억
  track_b:
    max_capital_impairment: 50
    min_current_ratio: 100
    min_trading_value: 500000000   # 5억

llm:
  ollama:
    model: "deepseek-r1:14b"
    timeout: 60
  claude:
    timeout: 120

output:
  telegram:
    enabled: true
    bot_token: "${TELEGRAM_BOT_TOKEN}"
    chat_id: "${TELEGRAM_CHAT_ID}"
  local:
    base_path: "outputs"
```
